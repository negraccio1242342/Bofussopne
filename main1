local config = getgenv().Script and getgenv().Script["Aim assist"]
if not config or not config.Enabled then return end

--// Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

--// Config
local Smoothness = config.smoothing or 0.00125
local XShake = config.xshake or 0
local YShake = config.yshake or 0
local LockKey = config.Keybind or Enum.KeyCode.N
local UseFov = config.UseFov or false
local FovRadius = config.FOVRadius or 200

-- Resolver
local ResolverMode = config.Resolver and config.Resolver.Type or "None"
local ResolverEnabled = config.Resolver and config.Resolver.Enabled or false
local ResolverToggleKey = config.Resolver and config.Resolver.Keybind or Enum.KeyCode.R

-- Checks
local Checks = config.Checks or {
    Alive = true,
    Team = true,
    Visible = true
}

--// State
local isLocked = false
local lockTarget = nil

--// Drawing: FOV Circle
local fovCircle = Drawing.new("Circle")
fovCircle.Radius = FovRadius
fovCircle.Thickness = 1.5
fovCircle.NumSides = 64
fovCircle.Color = Color3.fromRGB(255, 255, 255)
fovCircle.Filled = false
fovCircle.Transparency = 0.75
fovCircle.Visible = UseFov

--// Utilities
local function isAlive(player)
    local char = player.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    local ko = char and char:FindFirstChild("BodyEffects") and char.BodyEffects:FindFirstChild("K.O")
    return hum and hum.Health > 0 and (not ko or not ko.Value)
end

local function isVisible(targetPart)
    if not targetPart then return false end

    local origin = Camera.CFrame.Position
    local direction = (targetPart.Position - origin).Unit * 999

    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {LocalPlayer.Character}
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist

    local result = Workspace:Raycast(origin, direction, rayParams)
    if not result then return true end

    local hit = result.Instance
    local hitParent = hit:FindFirstAncestorOfClass("Model")
    if hitParent and hitParent == targetPart.Parent then return true end
    if hit:IsDescendantOf(targetPart.Parent) then return true end

    return false
end

local function passesChecks(player)
    if player == LocalPlayer or not player.Character then return false end
    local hrp = player.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end

    if Checks.Alive and not isAlive(player) then return false end
    if Checks.Team and player.Team == LocalPlayer.Team then return false end
    if Checks.Visible and not isVisible(hrp) then return false end

    return true
end

local function applyResolver(player, position)
    if not ResolverEnabled or ResolverMode == "None" then return position end
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return position end

    local vel = hrp.Velocity
    local factor = 0.13
    if ResolverMode == "Aggressive" then factor *= 1.5
    elseif ResolverMode == "Safe" then factor *= 0.75 end

    return position + (vel * factor)
end

local function getClosestTarget()
    local closest, shortest = nil, math.huge
    local mousePos = UserInputService:GetMouseLocation()

    for _, player in ipairs(Players:GetPlayers()) do
        if passesChecks(player) then
            local hrp = player.Character.HumanoidRootPart
            local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
            if onScreen then
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                if (not UseFov or dist <= FovRadius) and dist < shortest then
                    shortest = dist
                    closest = player
                end
            end
        end
    end

    return closest
end

--// Keybinds
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end

    if input.KeyCode == LockKey then
        isLocked = not isLocked
        lockTarget = isLocked and getClosestTarget() or nil
    end

    if input.KeyCode == ResolverToggleKey then
        ResolverEnabled = not ResolverEnabled
        print("[Resolver] Toggled:", ResolverEnabled and "ENABLED" or "DISABLED")
    end
end)

--// Lock Loop
RunService.RenderStepped:Connect(function()
    -- Update FOV position
    fovCircle.Visible = UseFov
    fovCircle.Position = UserInputService:GetMouseLocation()

    if isLocked and lockTarget and passesChecks(lockTarget) then
        local hrp = lockTarget.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local targetPos = applyResolver(lockTarget, hrp.Position)
            local camCF = Camera.CFrame
            local targetCF = CFrame.lookAt(camCF.Position, targetPos)

            -- Smooth + Angular Camera Movement
            Camera.CFrame = camCF:Lerp(targetCF, Smoothness)

            if XShake > 0 or YShake > 0 then
                local angleX = math.rad(math.random(-XShake, XShake))
                local angleY = math.rad(math.random(-YShake, YShake))
                Camera.CFrame = Camera.CFrame * CFrame.Angles(angleY, angleX, 0)
            end
        end
    end
end)
